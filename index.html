<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Time Machine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0056b3; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Header Card */
        .header-card { background: white; padding: 25px 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        .label-text { font-size: 0.85em; color: #888; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; }
        .total-value { font-size: 2.5em; font-weight: 800; color: var(--primary); margin: 5px 0 20px 0; letter-spacing: -1px; }
        
        /* Filter Row */
        .filter-row { display: flex; justify-content: center; margin-bottom: 15px; }
        .btn-group { display: flex; background: #eef2f5; border-radius: 12px; padding: 4px; }
        .filter-btn { padding: 8px 24px; border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600; font-size: 0.95em; border-radius: 10px; transition: all 0.2s; }
        .filter-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Date Dropdown (Fixed Layout) */
        .date-row { margin-top: 10px; display: flex; justify-content: center; }
        .date-select { 
            appearance: none; -webkit-appearance: none; 
            background: #fff url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 15px center;
            background-size: 12px;
            padding: 10px 40px 10px 20px; border-radius: 30px; border: 2px solid #eef2f5; 
            font-size: 0.95em; color: #444; font-weight: 500; width: 100%; max-width: 280px; text-align: center;
        }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .chart-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); height: 220px; }
        @media (max-width: 600px) { .charts-grid { grid-template-columns: 1fr; } }

        /* Table */
        .table-card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fcfcfc; padding: 15px; text-align: left; font-size: 0.75em; color: #999; text-transform: uppercase; border-bottom: 1px solid #f0f0f0; }
        td { padding: 15px; border-bottom: 1px solid #f8f8f8; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .ticker { font-weight: 700; color: #2c3e50; font-size: 1em; display: block; }
        .owner-badge { font-size: 0.7em; background: #eef2f5; color: #666; padding: 2px 8px; border-radius: 4px; font-weight: 600; margin-left: 5px; vertical-align: text-top; }
        .qty-text { font-size: 0.8em; color: #999; margin-top: 2px; }
        .money { font-family: 'Segoe UI', monospace; font-weight: 600; color: #333; }
        .price-sub { font-size: 0.8em; color: #999; display: block; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="label-text" id="dateLabel">Total Net Worth</div>
        <div class="total-value" id="displayTotal">Loading...</div>
        
        <div class="filter-row">
            <div class="btn-group">
                <button class="filter-btn active" onclick="setOwnerFilter('ALL')">ALL</button>
                <button class="filter-btn" onclick="setOwnerFilter('URP')">URP</button>
                <button class="filter-btn" onclick="setOwnerFilter('DUP')">DUP</button>
            </div>
        </div>

        <div class="date-row">
            <select class="date-select" id="dateFilter" onchange="setDateFilter(this.value)">
                <option value="LATEST">Live Data (Latest)</option>
                </select>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <canvas id="growthChart"></canvas>
        </div>
        <div class="chart-card">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div class="table-card">
        <table id="stockTable">
            <thead>
                <tr>
                    <th>Stock</th>
                    <th style="text-align:right">Price</th>
                    <th style="text-align:right">Value</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRw_iz9-dZrycABZQ_unuvRj8Pgeu6JSANkQyFlbQYEKzd9GyiqzgPAz6T492I32LhT37sJBp8JzU1o/pub?output=csv";
    // ---------------------

    let allData = [];
    let currentOwner = 'ALL';
    let timeTravelIndex = -1; 
    let mainPieChart = null;
    let mainGrowthChart = null;

    async function init() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const rows = text.split('\n').slice(1);

            allData = rows.map(row => {
                const c = row.split(',');
                if (c.length < 6) return null;
                const histRaw = c[4].replace(/"/g, '').split('|').map(Number).filter(n => !isNaN(n));
                return {
                    ticker: c[0].replace('NSE:', '').replace('BOM:', ''),
                    qty: parseFloat(c[1]),
                    avg: parseFloat(c[2]),
                    livePrice: parseFloat(c[3]),
                    history: histRaw,
                    owner: c[5].trim().toUpperCase()
                };
            }).filter(item => item && item.qty);

            populateDateDropdown();
            renderDashboard();

        } catch (err) { console.error(err); alert("Error loading data"); }
    }

    function populateDateDropdown() {
        const select = document.getElementById('dateFilter');
        // Limit drop down to 10 days to save scrolling space on mobile
        for (let i = 1; i <= 20; i++) {
            const option = document.createElement('option');
            option.value = i; 
            option.text = `${i} Days Ago`;
            select.appendChild(option);
        }
    }

    function setOwnerFilter(filter) {
        currentOwner = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === filter);
        });
        renderDashboard();
    }

    function setDateFilter(val) {
        timeTravelIndex = val === "LATEST" ? -1 : parseInt(val);
        const label = timeTravelIndex === -1 ? "Total Net Worth" : `Net Worth (${timeTravelIndex} Days Ago)`;
        document.getElementById('dateLabel').innerText = label;
        renderDashboard();
    }

    function renderDashboard() {
        const tbody = document.querySelector('#stockTable tbody');
        tbody.innerHTML = '';
        
        const filtered = allData.filter(d => currentOwner === 'ALL' || d.owner === currentOwner);
        let grandTotal = 0;
        let pieLabels = [];
        let pieValues = [];
        let portfolioHistory = new Array(30).fill(0); 

        filtered.forEach(item => {
            let displayPrice = item.livePrice;
            if (timeTravelIndex !== -1) {
                const histIndex = item.history.length - 1 - timeTravelIndex;
                if (histIndex >= 0 && histIndex < item.history.length) displayPrice = item.history[histIndex];
            }

            const val = item.qty * displayPrice;
            grandTotal += val;
            pieLabels.push(item.ticker);
            pieValues.push(val);

            // History Chart Calculation
            const offset = 30 - item.history.length;
            item.history.forEach((p, idx) => {
                const globalIdx = idx + offset;
                if(globalIdx >= 0 && globalIdx < 30) portfolioHistory[globalIdx] += (p * item.qty);
            });

            // Draw Row
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <span class="ticker">${item.ticker}<span class="owner-badge">${item.owner}</span></span>
                    <div class="qty-text">${item.qty} shares</div>
                </td>
                <td style="text-align:right">
                    <div class="money">₹${displayPrice.toFixed(2)}</div>
                    <div class="price-sub">${timeTravelIndex === -1 ? 'Live' : 'Past'}</div>
                </td>
                <td style="text-align:right" class="money">₹${Math.round(val).toLocaleString('en-IN')}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('displayTotal').innerText = '₹' + grandTotal.toLocaleString('en-IN', {maximumFractionDigits: 0});
        updateCharts(pieLabels, pieValues, portfolioHistory);
    }

    function updateCharts(pLabels, pValues, gData) {
        // Pie
        const pCtx = document.getElementById('pieChart');
        if (mainPieChart) mainPieChart.destroy();
        mainPieChart = new Chart(pCtx, {
            type: 'doughnut',
            data: {
                labels: pLabels,
                datasets: [{ data: pValues, backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7','#9c755f'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, title: {display: true, text: 'Allocation'} } }
        });

        // Growth
        const gCtx = document.getElementById('growthChart');
        if (mainGrowthChart) mainGrowthChart.destroy();
        const isUp = gData[29] >= gData[0];
        mainGrowthChart = new Chart(gCtx, {
            type: 'line',
            data: {
                labels: Array.from({length:30}, (_,i)=>i),
                datasets: [{ data: gData, borderColor: isUp?'#28a745':'#dc3545', backgroundColor: isUp?'rgba(40,167,69,0.1)':'rgba(220,53,69,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, title: {display: true, text: '30-Day Growth'}, tooltip: {enabled: false} }, scales: {x:{display:false}, y:{display:false}} }
        });
    }

    init();
</script>

</body>
</html>
