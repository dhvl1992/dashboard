<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Time Machine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0056b3; --bg: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        
        /* Header Card */
        .header-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; margin-bottom: 15px; }
        .total-value { font-size: 2.2em; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .sub-text { font-size: 0.9em; color: #666; margin-bottom: 15px; }
        
        /* Controls Row */
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        
        /* Filter Buttons */
        .btn-group { display: flex; border: 1px solid var(--primary); border-radius: 20px; overflow: hidden; }
        .filter-btn { padding: 8px 16px; border: none; background: white; color: var(--primary); cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .filter-btn.active { background: var(--primary); color: white; }
        .filter-btn:not(:last-child) { border-right: 1px solid var(--primary); }

        /* Date Select */
        .date-select { padding: 8px 12px; border-radius: 20px; border: 1px solid #ccc; font-size: 0.9em; background: white; color: #333; cursor: pointer; outline: none; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .chart-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: 220px; position: relative; }
        @media (max-width: 600px) { .charts-grid { grid-template-columns: 1fr; } }

        /* Table */
        .table-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 0.8em; color: #666; border-bottom: 1px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .ticker { font-weight: bold; color: #2c3e50; }
        .owner-badge { font-size: 0.7em; background: #e3f2fd; color: #0056b3; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .money { font-family: monospace; font-weight: 600; font-size: 1em; }
        
        /* Changes colors */
        .diff-pos { color: #28a745; font-size: 0.8em; }
        .diff-neg { color: #dc3545; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div id="dateLabel">Total Net Worth</div>
        <div class="total-value" id="displayTotal">Loading...</div>
        
        <div class="controls">
            <div class="btn-group">
                <button class="filter-btn active" onclick="setOwnerFilter('ALL')">ALL</button>
                <button class="filter-btn" onclick="setOwnerFilter('URP')">URP</button>
                <button class="filter-btn" onclick="setOwnerFilter('DUP')">DUP</button>
            </div>
            
            <select class="date-select" id="dateFilter" onchange="setDateFilter(this.value)">
                <option value="LATEST">ðŸ“… Latest (Live)</option>
                </select>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <canvas id="growthChart"></canvas>
        </div>
        <div class="chart-card">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div class="table-card">
        <div class="table-wrapper">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th>Stock</th>
                        <th>Price <span id="priceHeaderLabel">(Live)</span></th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRw_iz9-dZrycABZQ_unuvRj8Pgeu6JSANkQyFlbQYEKzd9GyiqzgPAz6T492I32LhT37sJBp8JzU1o/pub?output=csv";
    // ---------------------

    let allData = [];
    let currentOwner = 'ALL';
    let timeTravelIndex = -1; // -1 means Latest. 0 = Oldest data point, 29 = Newest data point.
    
    let mainPieChart = null;
    let mainGrowthChart = null;

    async function init() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const rows = text.split('\n').slice(1);

            allData = rows.map(row => {
                const c = row.split(',');
                if (c.length < 6) return null;
                
                const histRaw = c[4].replace(/"/g, '').split('|').map(Number).filter(n => !isNaN(n));
                
                return {
                    ticker: c[0].replace('NSE:', '').replace('BOM:', ''),
                    qty: parseFloat(c[1]),
                    avg: parseFloat(c[2]),
                    livePrice: parseFloat(c[3]),
                    history: histRaw, // Array of ~30 prices [Oldest ..... Newest]
                    owner: c[5].trim().toUpperCase()
                };
            }).filter(item => item && item.qty);

            populateDateDropdown();
            renderDashboard();

        } catch (err) { console.error(err); alert("Error loading data"); }
    }

    // Generate "T-1 Day", "T-2 Days" options
    function populateDateDropdown() {
        const select = document.getElementById('dateFilter');
        // We assume roughly 30 data points. We count backwards.
        // History Array: [Day-30, Day-29 ... Day-1, Today]
        // So index 29 is Today. Index 28 is Yesterday.
        
        for (let i = 1; i < 30; i++) {
            const option = document.createElement('option');
            // Logic: "0" means calculate the array index corresponding to "i days ago"
            option.value = i; 
            option.text = `â†º ${i} Market Days Ago`;
            select.appendChild(option);
        }
    }

    function setOwnerFilter(filter) {
        currentOwner = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === filter);
        });
        renderDashboard();
    }

    function setDateFilter(val) {
        if (val === "LATEST") {
            timeTravelIndex = -1;
            document.getElementById('priceHeaderLabel').innerText = "(Live)";
            document.getElementById('dateLabel').innerText = "Total Net Worth";
        } else {
            // Convert "days ago" to array index
            // If array length is 30. 1 day ago is index 28. 5 days ago is index 24.
            const daysAgo = parseInt(val);
            timeTravelIndex = daysAgo; // We will handle the array math inside the loop
            document.getElementById('priceHeaderLabel').innerText = `(Day -${daysAgo})`;
            document.getElementById('dateLabel').innerText = `Value ${daysAgo} Days Ago`;
        }
        renderDashboard();
    }

    function renderDashboard() {
        const tbody = document.querySelector('#stockTable tbody');
        tbody.innerHTML = '';
        
        const filtered = allData.filter(d => currentOwner === 'ALL' || d.owner === currentOwner);
        
        let grandTotal = 0;
        let pieLabels = [];
        let pieValues = [];
        let portfolioHistory = new Array(30).fill(0); // For the chart

        filtered.forEach(item => {
            // --- TIME TRAVEL LOGIC ---
            let displayPrice = item.livePrice;
            
            // If Time Travel is active
            if (timeTravelIndex !== -1) {
                // history array: [old ... new]
                // index = length - 1 - daysAgo
                const histIndex = item.history.length - 1 - timeTravelIndex;
                if (histIndex >= 0 && histIndex < item.history.length) {
                    displayPrice = item.history[histIndex];
                }
            }

            const val = item.qty * displayPrice;
            grandTotal += val;
            
            // Pie Data
            pieLabels.push(item.ticker);
            pieValues.push(val);

            // Growth Chart Data (Summing history)
            // We align arrays to the right (Newest)
            const offset = 30 - item.history.length;
            item.history.forEach((p, idx) => {
                const globalIdx = idx + offset;
                if(globalIdx >= 0 && globalIdx < 30) {
                    portfolioHistory[globalIdx] += (p * item.qty);
                }
            });

            // Table Row
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="ticker">${item.ticker} <span class="owner-badge">${item.owner}</span></div>
                    <div style="font-size:0.8em; color:#888">${item.qty} Qty</div>
                </td>
                <td class="money">â‚¹${displayPrice.toFixed(2)}</td>
                <td class="money">â‚¹${Math.round(val).toLocaleString('en-IN')}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('displayTotal').innerText = 'â‚¹' + grandTotal.toLocaleString('en-IN', {maximumFractionDigits: 0});

        // Update Charts
        updatePieChart(pieLabels, pieValues);
        updateGrowthChart(portfolioHistory);
    }

    // --- CHART DRAWING ---
    function updatePieChart(labels, values) {
        const ctx = document.getElementById('pieChart');
        if (mainPieChart) mainPieChart.destroy();
        
        mainPieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ac'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Allocation' } }
            }
        });
    }

    function updateGrowthChart(data) {
        const ctx = document.getElementById('growthChart');
        if (mainGrowthChart) mainGrowthChart.destroy();

        // Calculate color (Green if grew, Red if shrank)
        const isGrowing = data[data.length-1] >= data[0];
        const lineColor = isGrowing ? '#28a745' : '#dc3545';
        const bgFill = isGrowing ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';

        mainGrowthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 30}, (_, i) => i), // Dummy labels
                datasets: [{
                    data: data,
                    borderColor: lineColor,
                    backgroundColor: bgFill,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: '30-Day Growth' }, tooltip: {enabled: false} },
                scales: { x: { display: false }, y: { display: false } }
            }
        });
    }

    init();
</script>

</body>
</html>
